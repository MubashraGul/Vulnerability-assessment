import requests
from tkinter import END

def test_sql_injection(url, payloads, result_text, output_stream=None):
    results = f"SQL Injection results for URL: {url}\n"

    try:
        for payload in payloads:
            # Construct the query parameter with the payload
            params = {'id': payload}

            # Send the request
            response = requests.get(url, params=params)

            # Check if the response status code indicates success
            if response.status_code == 200:
                # Check for common SQL error messages in the response text
                if any(error_msg in response.text for error_msg in [
                    "You have an error in your SQL syntax",
                    "Warning: mysql_fetch_assoc()",
                    "Warning: pg_exec()",
                    "Microsoft OLE DB Provider for SQL Server",
                    "Unclosed quotation mark",
                    "quoted string not properly terminated"
                ]):
                    result_message = f"Potential SQL Injection vulnerability detected with payload: {payload}\n"
                else:
                    result_message = f"No vulnerability detected with payload: {payload}\n"
            else:
                result_message = f"Request failed with status code: {response.status_code}\n"

            results += result_message
            result_text.insert(END, result_message)

            if output_stream:
                output_stream.write(result_message)

    except requests.RequestException as e:
        # Handle any request-related exceptions
        result_message = f"Request failed: {e}\n"
        results += result_message
        result_text.insert(END, result_message)

        if output_stream:
            output_stream.write(result_message)

    return results
